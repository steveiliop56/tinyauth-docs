import{r as J}from"./chunk-ZMWYLUDP-oajMeTFk.js";import{c as H}from"./chunk-OTD7MV33-qJr9DjGl.js";import{j as k,k as T,l as N,m as Z,s as ee,n as O,r as R,o as B,p as te,q as z,t as Y,v as ne,w as K,D as oe,x as ce}from"./root-DzVTnnpn.js";import"./index-BDrdAJGi.js";import"./button-C7aBqFiu.js";import"./index-D6_Pffze.js";function se(e,t){return e.documentsStore.get(e.data.docs,t)}function re(e){return e.documentsStore.count(e.data.docs)}const F="fulltext",ie="hybrid",ue="vector";function le(e,t){return e[1]-t[1]}function de(e,t){return t[1]-e[1]}function fe(e="desc"){return e.toLowerCase()==="asc"?le:de}function P(e,t,o){const n={},i=t.map(([u])=>u),c=e.documentsStore.getMultiple(e.data.docs,i),f=Object.keys(o),r=e.index.getSearchablePropertiesWithTypes(e.data.index);for(const u of f){let h;if(r[u]==="number"){const{ranges:s}=o[u],d=s.length,p=Array.from({length:d});for(let l=0;l<d;l++){const S=s[l];p[l]=[`${S.from}-${S.to}`,0]}h=Object.fromEntries(p)}n[u]={count:0,values:h??{}}}const g=c.length;for(let u=0;u<g;u++){const h=c[u];for(const s of f){const d=s.includes(".")?k(h,s):h[s],p=r[s],l=n[s].values;switch(p){case"number":{const S=o[s].ranges;j(S,l)(d);break}case"number[]":{const S=new Set,b=o[s].ranges,a=j(b,l,S);for(const y of d)a(y);break}case"boolean":case"enum":case"string":{m(l,p)(d);break}case"boolean[]":case"enum[]":case"string[]":{const a=m(l,p==="boolean[]"?"boolean":"string",new Set);for(const y of d)a(y);break}default:throw T("FACET_NOT_SUPPORTED",p)}}}for(const u of f){const h=n[u];if(h.count=Object.keys(h.values).length,r[u]==="string"){const s=o[u],d=fe(s.sort);h.values=Object.fromEntries(Object.entries(h.values).sort(d).slice(s.offset??0,s.limit??10))}}return n}function j(e,t,o){return n=>{for(const i of e){const c=`${i.from}-${i.to}`;o?.has(c)||n>=i.from&&n<=i.to&&(t[c]===void 0?t[c]=1:(t[c]++,o?.add(c)))}}}function m(e,t,o){const n=t==="boolean"?"false":"";return i=>{const c=i?.toString()??n;o?.has(c)||(e[c]=(e[c]??0)+1,o?.add(c))}}const he={reducer:(e,t,o,n)=>(t[n]=o,t),getInitialValue:e=>Array.from({length:e})},M=["string","number","boolean"];function L(e,t,o){const n=o.properties,i=n.length,c=e.index.getSearchablePropertiesWithTypes(e.data.index);for(let a=0;a<i;a++){const y=n[a];if(typeof c[y]>"u")throw T("UNKNOWN_GROUP_BY_PROPERTY",y);if(!M.includes(c[y]))throw T("INVALID_GROUP_BY_PROPERTY",y,M.join(", "),c[y])}const f=t.map(([a])=>N(e.internalDocumentIDStore,a)),r=e.documentsStore.getMultiple(e.data.docs,f),g=r.length,u=o.maxResult||Number.MAX_SAFE_INTEGER,h=[],s={};for(let a=0;a<i;a++){const y=n[a],I={property:y,perValue:{}},D=new Set;for(let x=0;x<g;x++){const w=r[x],v=k(w,y);if(typeof v>"u")continue;const E=typeof v!="boolean"?v:""+v,A=I.perValue[E]??{indexes:[],count:0};A.count>=u||(A.indexes.push(x),A.count++,I.perValue[E]=A,D.add(v))}h.push(Array.from(D)),s[y]=I}const d=$(h),p=d.length,l=[];for(let a=0;a<p;a++){const y=d[a],I=y.length,D={values:[],indexes:[]},x=[];for(let w=0;w<I;w++){const v=y[w],E=n[w];x.push(s[E].perValue[typeof v!="boolean"?v:""+v].indexes),D.values.push(v)}D.indexes=Z(x).sort((w,v)=>w-v),D.indexes.length!==0&&l.push(D)}const S=l.length,b=Array.from({length:S});for(let a=0;a<S;a++){const y=l[a],I=o.reduce||he,D=y.indexes.map(E=>({id:f[E],score:t[E][1],document:r[E]})),x=I.reducer.bind(null,y.values),w=I.getInitialValue(y.indexes.length),v=D.reduce(x,w);b[a]={values:y.values,result:v}}return b}function $(e,t=0){if(t+1===e.length)return e[t].map(c=>[c]);const o=e[t],n=$(e,t+1),i=[];for(const c of o)for(const f of n){const r=[c];ee(r,f),i.push(r)}return i}function G(e,t,o){const{term:n,properties:i}=t,c=e.data.index;let f=e.caches.propertiesToSearch;if(!f){const s=e.index.getSearchablePropertiesWithTypes(c);f=e.index.getSearchableProperties(c),f=f.filter(d=>s[d].startsWith("string")),e.caches.propertiesToSearch=f}if(i&&i!=="*"){for(const s of i)if(!f.includes(s))throw T("UNKNOWN_INDEX",s,f.join(", "));f=f.filter(s=>i.includes(s))}const r=Object.keys(t.where??{}).length>0;let g;r&&(g=e.index.searchByWhereClause(c,e.tokenizer,t.where,o));let u;const h=t.threshold!==void 0&&t.threshold!==null?t.threshold:1;if(n||i){const s=re(e);u=e.index.search(c,n||"",e.tokenizer,o,f,t.exact||!1,t.tolerance||0,t.boost||{},ge(t.relevance),s,g,h)}else if(r){const s=ne(c,t.where);s?u=s:u=(g?Array.from(g):[]).map(p=>[+p,0])}else u=Object.keys(e.documentsStore.getAll(e.data.docs)).map(d=>[+d,0]);return u}function ae(e,t,o){const n=O();function i(){const r=Object.keys(e.data.index.vectorIndexes),g=t.facets&&Object.keys(t.facets).length>0,{limit:u=10,offset:h=0,distinctOn:s,includeVectors:d=!1}=t,p=t.preflight===!0;let l=G(e,t,o);if(t.sortBy)if(typeof t.sortBy=="function"){const a=l.map(([D])=>D),I=e.documentsStore.getMultiple(e.data.docs,a).map((D,x)=>[l[x][0],l[x][1],D]);I.sort(t.sortBy),l=I.map(([D,x])=>[D,x])}else l=e.sorter.sortBy(e.data.sorting,l,t.sortBy).map(([a,y])=>[te(e.internalDocumentIDStore,a),y]);else l=l.sort(z);let S;p||(S=s?ve(e,l,h,u,s):Q(e,l,h,u));const b={elapsed:{formatted:"",raw:0},hits:[],count:l.length};if(typeof S<"u"&&(b.hits=S.filter(Boolean),d||Y(b,r)),g){const a=P(e,l,t.facets);b.facets=a}return t.groupBy&&(b.groups=L(e,l,t.groupBy)),b.elapsed=e.formatElapsedTime(O()-n),b}async function c(){e.beforeSearch&&await R(e.beforeSearch,e,t,o);const r=i();return e.afterSearch&&await B(e.afterSearch,e,t,o,r),r}return e.beforeSearch?.length||e.afterSearch?.length?c():i()}const V={k:1.2,b:.75,d:.5};function ge(e){const t=e??{};return t.k=t.k??V.k,t.b=t.b??V.b,t.d=t.d??V.d,t}function X(e,t,o){const n=t.vector;if(n&&(!("value"in n)||!("property"in n)))throw T("INVALID_VECTOR_INPUT",Object.keys(n).join(", "));const i=e.data.index.vectorIndexes[n.property];if(!i)throw T("UNKNOWN_VECTOR_PROPERTY",n.property);const c=i.node.size;if(n?.value.length!==c)throw n?.property===void 0||n?.value.length===void 0?T("INVALID_INPUT_VECTOR","undefined",c,"undefined"):T("INVALID_INPUT_VECTOR",n.property,c,n.value.length);const f=e.data.index;let r;return Object.keys(t.where??{}).length>0&&(r=e.index.searchByWhereClause(f,e.tokenizer,t.where,o)),i.node.find(n.value,t.similarity??oe,r)}function pe(e,t,o="english"){const n=O();function i(){const r=X(e,t,o).sort(z);let g=[];t.facets&&Object.keys(t.facets).length>0&&(g=P(e,r,t.facets));const h=t.vector.property,s=t.includeVectors??!1,d=t.limit??10,p=t.offset??0,l=Array.from({length:d});for(let y=0;y<d;y++){const I=r[y+p];if(!I)break;const D=e.data.docs.docs[I[0]];if(D){s||(D[h]=null);const x={id:N(e.internalDocumentIDStore,I[0]),score:I[1],document:D};l[y]=x}}let S=[];t.groupBy&&(S=L(e,r,t.groupBy));const a=O()-n;return{count:r.length,hits:l.filter(Boolean),elapsed:{raw:Number(a),formatted:K(a)},...g?{facets:g}:{},...S?{groups:S}:{}}}async function c(){e.beforeSearch&&await R(e.beforeSearch,e,t,o);const r=i();return e.afterSearch&&await B(e.afterSearch,e,t,o,r),r}return e.beforeSearch?.length||e.afterSearch?.length?c():i()}function ye(e,t,o){const n=be(G(e,t,o)),i=X(e,t,o),c=t.hybridWeights;return Ie(n,i,t.term??"",c)}function Se(e,t,o){const n=O();function i(){const r=ye(e,t,o);let g;t.facets&&Object.keys(t.facets).length>0&&(g=P(e,r,t.facets));let h;t.groupBy&&(h=L(e,r,t.groupBy));const s=t.offset??0,d=t.limit??10,p=Q(e,r,s,d).filter(Boolean),l=O(),S={count:r.length,elapsed:{raw:Number(l-n),formatted:K(l-n)},hits:p,...g?{facets:g}:{},...h?{groups:h}:{}};if(!(t.includeVectors??!1)){const a=Object.keys(e.data.index.vectorIndexes);Y(S,a)}return S}async function c(){e.beforeSearch&&await R(e.beforeSearch,e,t,o);const r=i();return e.afterSearch&&await B(e.afterSearch,e,t,o,r),r}return e.beforeSearch?.length||e.afterSearch?.length?c():i()}function _(e){return e[1]}function be(e){const t=Math.max.apply(Math,e.map(_));return e.map(([o,n])=>[o,n/t])}function C(e,t){return e/t}function De(e,t){return(o,n)=>o*e+n*t}function Ie(e,t,o,n){const i=Math.max.apply(Math,e.map(_)),c=Math.max.apply(Math,t.map(_)),f=n&&n.text&&n.vector,{text:r,vector:g}=f?n:xe(),u=new Map,h=e.length,s=De(r,g);for(let p=0;p<h;p++){const[l,S]=e[p],b=C(S,i),a=s(b,0);u.set(l,a)}const d=t.length;for(let p=0;p<d;p++){const[l,S]=t[p],b=C(S,c),a=u.get(l)??0;u.set(l,a+s(0,b))}return[...u].sort((p,l)=>l[1]-p[1])}function xe(e){return{text:.5,vector:.5}}function q(e,t,o){const n=t.mode??F;if(n===F)return ae(e,t,o);if(n===ue)return pe(e,t);if(n===ie)return Se(e,t);throw T("INVALID_SEARCH_MODE",n)}function ve(e,t,o,n,i){const c=e.data.docs,f=new Map,r=[],g=new Set,u=t.length;let h=0;for(let s=0;s<u;s++){const d=t[s];if(typeof d>"u")continue;const[p,l]=d;if(g.has(p))continue;const S=e.documentsStore.get(c,p),b=k(S,i);if(!(typeof b>"u"||f.has(b))&&(f.set(b,!0),h++,!(h<=o)&&(r.push({id:N(e.internalDocumentIDStore,p),score:l,document:S}),g.add(p),h>=o+n)))break}return r}function Q(e,t,o,n){const i=e.data.docs,c=Array.from({length:n}),f=new Set;for(let r=o;r<n+o;r++){const g=t[r];if(typeof g>"u")break;const[u,h]=g;if(!f.has(u)){const s=e.documentsStore.get(i,u);c[r]={id:N(e.internalDocumentIDStore,u),score:h,document:s},f.add(u)}}return c}function W(e,t){e.internalDocumentIDStore.load(e,t.internalDocumentIDStore),e.data.index=e.index.load(e.internalDocumentIDStore,t.index),e.data.docs=e.documentsStore.load(e.internalDocumentIDStore,t.docs),e.data.sorting=e.sorter.load(e.internalDocumentIDStore,t.sorting),e.tokenizer.language=t.language}async function we(e,t,o={}){const n=H(t);return(await q(e,{term:t,tolerance:1,...o,boost:{title:2,..."boost"in o?o.boost:void 0}})).hits.map(c=>({type:"page",content:c.document.title,breadcrumbs:c.document.breadcrumbs,contentWithHighlights:n.highlight(c.document.title),id:c.document.url,url:c.document.url}))}async function Te(e,t,o=[],{mode:n="fulltext",...i}={}){typeof o=="string"&&(o=[o]);let c={...i,mode:n,where:J({tags:o.length>0?{containsAll:o}:void 0,...i.where}),groupBy:{properties:["page_id"],maxResult:8,...i.groupBy}};t.length>0&&(c={...c,term:t,properties:n==="fulltext"?["content"]:["content","embeddings"]});const f=H(t),r=await q(e,c),g=[];for(const u of r.groups??[]){const h=u.values[0],s=se(e,h);if(s){g.push({id:h,type:"page",content:s.content,breadcrumbs:s.breadcrumbs,contentWithHighlights:f.highlight(s.content),url:s.url});for(const d of u.result)d.document.type!=="page"&&g.push({id:d.document.id.toString(),content:d.document.content,breadcrumbs:d.document.breadcrumbs,contentWithHighlights:f.highlight(d.document.content),type:d.document.type,url:d.document.url})}}return g}var U=new Map;async function Ee({from:e="/api/search",initOrama:t=o=>ce({schema:{_:"string"},language:o})}){const o=e,n=U.get(o);if(n)return n;async function i(){const f=await fetch(e);if(!f.ok)throw new Error(`failed to fetch exported search indexes from ${e}, make sure the search database is exported and available for client.`);const r=await f.json(),g=new Map;if(r.type==="i18n")return await Promise.all(Object.entries(r.data).map(async([h,s])=>{const d=await t(h);W(d,s),g.set(h,{type:s.type,db:d})})),g;const u=await t();return W(u,r),g.set("",{type:r.type,db:u}),g}const c=i();return U.set(o,c),c}async function Re(e,t){const{tag:o,locale:n}=t,i=(await Ee(t)).get(n??"");return i?i.type==="simple"?we(i,e):Te(i.db,e,o):[]}export{Re as search};
